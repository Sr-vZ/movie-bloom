<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>title</title>
    <!-- <link rel="stylesheet" href="//fonts.googleapis.com/css?family=font1|font2|etc" type="text/css"> -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB"
        crossorigin="anonymous">
</head>

<body>
    <div id="movies-container" class="container">
        <!-- <div class="row">
            <div class="col">
                <p class="h2">h2. Bootstrap heading</p>
                <img src="..." class="img-fluid rounded float-left" alt="Responsive image">
            </div>
            <div class="col">
                <div id='chart-container'></div>
                <p>Release Date</p>
                <p>01/07/2018</p>
                <p>Originally billed as:</p>
                <p>Gernes</p>
                <p></p>
                <p class="h4"> SYNOPSIS</p>
                <p>synopsis details</p>
            </div>
        </div> -->
    </div>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>
    <script>
        genres = [{
                id: 28,
                name: 'Action'
            },
            {
                id: 12,
                name: 'Adventure'
            },
            {
                id: 16,
                name: 'Animation'
            },
            {
                id: 35,
                name: 'Comedy'
            },
            {
                id: 80,
                name: 'Crime'
            },
            {
                id: 99,
                name: 'Documentary'
            },
            {
                id: 18,
                name: 'Drama'
            },
            {
                id: 10751,
                name: 'Family'
            },
            {
                id: 14,
                name: 'Fantasy'
            },
            {
                id: 36,
                name: 'History'
            },
            {
                id: 27,
                name: 'Horror'
            },
            {
                id: 10402,
                name: 'Music'
            },
            {
                id: 9648,
                name: 'Mystery'
            },
            {
                id: 10749,
                name: 'Romance'
            },
            {
                id: 878,
                name: 'Science Fiction'
            },
            {
                id: 10770,
                name: 'TV Movie'
            },
            {
                id: 53,
                name: 'Thriller'
            },
            {
                id: 10752,
                name: 'War'
            },
            {
                id: 37,
                name: 'Western'
            }
        ]

        function getMovieIDs(pageNo) {
            if (pageNo === null || pageNo === undefined)
                pageNo = 1

            const url =
                'https://api.themoviedb.org/3/discover/movie?api_key=9eed022e522148efdb5a1fc5d8900333&language=en-US&sort_by=popularity.desc&include_adult=false&include_video=false&page=' +
                pageNo
            console.log("Url: " + url);

            return fetch(url, {
                    method: 'get',
                    // agent: new HttpsProxyAgent('http://proxy.intra.bt.com:8080')
                })
                .then(response => response.json())

        }
        var data = []

        function loadMovies(pageNo) {
            getMovieIDs(pageNo)
                .then(rdata => {
                    // console.log(rdata.results.length)

                    // var data = []

                    for (i = 0; i < rdata.results.length; i++) {

                        for (j = 0; j < rdata.results[i].genre_ids.length; j++) {
                            var genre = [];
                            for (k = 0; k < genres.length; k++) {
                                if (genres[k].id === rdata.results[i].genre_ids[j])
                                    genre.push(genres[k].name)
                            }
                            // genre.push(getGenreFromID(rdata.results[i].genre_ids[j]))
                        }
                        data.push({
                            id: rdata.results[i].id,
                            release_date: rdata.results[i].release_date,
                            synopsis: rdata.results[i].overview,
                            img: 'https://image.tmdb.org/t/p/w500' + rdata.results[i].poster_path,
                            genres: genre,
                            title: rdata.results[i].title
                        })
                        // movieData = movieData.concat(data)
                    }
                    var html = '';
                    for (i = 0; i < data.length; i++) {
                        html = html + createMoviecontainer(data[i].title, data[i].img, data[i].release_date,
                            data[i]
                            .synopsis, data[i].genres, data[i].id)
                        document.getElementById('movies-container').innerHTML = html
                        loadChart('canvas-' + data[i].id)
                    }
                    console.log(data)
                })
                .then(() => {
                    for (i = 0; i < data.length; i++) {
                        loadChart('canvas-' + data[i].id,randomArray(10,100))
                    }
                })
        }

        function randomArray(length, max) {
            return Array.apply(null, Array(length)).map(function () {
                return Math.round(Math.random() *
                    max);
            });
        }

        function createMoviecontainer(title, img, release_date, synopsis, genre, id) {

            html = '<div class="row">' +

                '<div class="col">' +
                '<p class="h2">' + title + '</p>' +
                '<img src="' + img + '" class="img-fluid rounded float-left" alt="Responsive image">' +
                '</div>' +
                '<div class="col">' +
                '<div id="chart-container-' + id + '"><canvas id="canvas-' + id + '"></canvas></div>' +
                '<p>Release Date: ' + release_date + '</p>' +

                '<p>Originally billed as: ' + genre + '</p>' +
                '<button type="button" class="btn btn-success" id="btn-' + id + '">Rate it!</button>' +
                '<p></p>' +
                '<p class="h4">SYNOPSIS</p>' +
                '<p>' + synopsis + '</p>' +
                '</div></div></div>'
            return html
        }

        function loadChart(ctxID, data) {
            var ctx = document.getElementById(ctxID).getContext('2d');
            var chart = new Chart(ctx, {
                // The type of chart we want to create
                type: 'horizontalBar',

                // The data for our dataset
                data: {
                    labels: ["Action", "Adventure", "Suspense", "Mystery", "Drama", "Horror", "Romance",
                        "Comedy", "Science Fiction", "Fantasy"
                    ],
                    datasets: [{
                        // label: "My First dataset",
                        backgroundColor: 'rgb(255, 99, 132)',
                        borderColor: 'rgb(255, 99, 132)',
                        data: data,
                    }]
                },

                // Configuration options go here
                options: {}
            });
        }

        $(document).ready(function () {
            loadMovies(1, function () {
                for (i = 0; i < data.length; i++) {
                    loadChart('canvas-' + data[i].id)
                }
            })

        });
    </script>
</body>

</html>